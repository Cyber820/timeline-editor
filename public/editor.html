<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>匿名时间轴编辑器</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
    }

    #timeline {
      width: 100%;
      height: 800px; /* ✅ 画布高度 */
      border: 1px solid lightgray;
    }

    .vis-tooltip {
      font-size: 10px;         /* ✅ 悬停窗口字体大小 */
      line-height: 1.2;        /* ✅ 悬停窗口行距 */
      max-width: 600px;
      white-space: normal !important;
    }

    .vis-item {
      font-size: 8px;          /* ✅ 事件框字体大小 */
      padding: 1px 2px;        /* ✅ 内边距 */
    }

    #event-form {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 999;
      display: none;
    }

    label {
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h3>匿名时间轴编辑器</h3>
  <button onclick="showForm()">➕ 增加事件</button>
  <div id="timeline"></div>

  <div id="event-form">
    <h4>新增事件</h4>
    <label>事件名称：<input type="text" id="title"></label>
    <label>事件类型：<select id="eventType"></select></label>
    <label>开始时间：<input type="date" id="start"></label>
    <label>结束时间：<input type="date" id="end"></label>
    <label>地区：<select id="region"></select></label>
    <label>平台类型：<select id="platform"></select></label>
    <label id="consoleLabel" style="display:none">主机类型：<select id="console"></select></label>
    <label>公司：<select id="company"></select></label>
    <label>描述：<textarea id="description" rows="3" cols="30"></textarea></label>
    <label>标签（多选）：<select id="tag" multiple></select></label>
    <label>提交者昵称（可选）：<input type="text" id="submitter" maxlength="12"></label>
    <button onclick="submitEvent()">提交</button>
    <button onclick="hideForm()">关闭</button>
  </div>

  <script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxcv6GqP5USv3zOn2pepoT3mke2fdZuWsoInq6qkDx-2LUMBQTcJpahOtRqUHqBYMjs/exec";

    function showForm() {
      document.getElementById('event-form').style.display = 'block';
    }
    function hideForm() {
      document.getElementById('event-form').style.display = 'none';
    }

    // 加载事件
    fetch(ENDPOINT)
      .then(res => res.json())
      .then(data => {
        const items = data.map(ev => ({
          id: ev.id,
          content: ev.content,
          start: ev.start,
          end: ev.end,
          title: (ev.title || '').replace(/\n/g, '<br>')
        }));

        const timeline = new vis.Timeline(document.getElementById('timeline'), items, {
          stack: true, // ✅ 是否堆叠事件框（可改成 false 测试重叠）
          margin: { item: 10, axis: 200 },
          orientation: { axis: 'bottom', item: 'bottom' },
          tooltip: { followMouse: true },
          zoomKey: 'ctrlKey'
        });
      });

    // 加载下拉数据
    fetch(ENDPOINT + '?action=options')
      .then(res => res.json())
      .then(options => {
        console.log("加载下拉数据成功：", options);
        const fillSelect = (id, values) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.innerHTML = '';
          values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            el.appendChild(opt);
          });
        };

        fillSelect("eventType", options.EventType);
        fillSelect("region", options.Region);
        fillSelect("platform", options.Platform);
        fillSelect("company", options.Company);
        fillSelect("tag", options.Tag);

        new Choices("#tag", {
          removeItemButton: true,
          searchPlaceholderValue: "搜索标签...",
          noResultsText: "无匹配项"
        });

        document.getElementById("platform").addEventListener("change", function () {
          const selected = this.value;
          const optionsMap = options.ConsolePlatform || {};
          const consoles = optionsMap[selected] || [];

          const consoleEl = document.getElementById("console");
          consoleEl.innerHTML = '';
          if (consoles.length > 0) {
            document.getElementById("consoleLabel").style.display = 'block';
            consoles.forEach(c => {
              const opt = document.createElement("option");
              opt.value = c;
              opt.textContent = c;
              consoleEl.appendChild(opt);
            });
          } else {
            document.getElementById("consoleLabel").style.display = 'none';
          }
        });
      })
      .catch(err => {
        console.error("下拉数据加载失败", err);
        alert("下拉数据加载失败，请检查接口和 CORS 设置");
      });

    function submitEvent() {
      alert("提交功能开发中...");
    }
  </script>
</body>
</html>
