<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç”µå­æ¸¸æˆæ—¶é—´è½´</title>
  <!-- æ ·å¼å’Œåº“ -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    #timeline { width: 100%; height: 800px; border: 1px solid lightgray; position: relative; }
    .vis-tooltip {
      white-space: normal !important; max-width: 700px !important; min-width: 300px;
      font-size: 10px; line-height: 1.2; padding: 12px; background-color: #fff;
      border: 1px solid #ccc; box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }
    .vis-item { font-size: 10px; padding: 1px 2px; background-color: #f5f5f5; border: 1px solid #aaa; border-radius: 4px; max-width: 300px; }
    #filter-window, #add-filter-window {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 20px; border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; z-index: 2000;
      max-height: 80vh; overflow: auto;
    }
    #filter-window { width: 700px; }
    #add-filter-window { width: 700px; height: 300px; }
  </style>
</head>
<body>
  <h2>ç”µå­æ¸¸æˆæ—¶é—´è½´</h2>
  <button onclick="openFilterWindow('and')">ğŸ” è¿‡æ»¤æ ‡å‡†</button>
  <div id="timeline"></div>

  <!-- è¿‡æ»¤çª—å£ -->
  <div id="filter-window">
    <h3>è¿‡æ»¤æ ‡å‡†ï¼ˆå’Œé€»è¾‘ï¼‰</h3>
    <button onclick="openAddFilter()">å¢åŠ è¿‡æ»¤æ ‡å‡†</button>
    <button onclick="resetFilters()">å¤åŸè¿‡æ»¤æ ‡å‡†</button>
    <button onclick="applyFilters()">åº”ç”¨å’Œé€»è¾‘</button>
    <button onclick="applyFiltersOr()">åº”ç”¨æˆ–é€»è¾‘</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">å…³é—­</button>
    <div id="current-filters"></div>
  </div>

  <!-- æ·»åŠ è¿‡æ»¤æ ‡å‡†çª—å£ -->
  <div id="add-filter-window">
    <h3>æ–°å¢è¿‡æ»¤æ ‡å‡†</h3>
    <label>è¿‡æ»¤å±æ€§ï¼š<select id="filter-attribute"></select></label><br>
    <label>è¿‡æ»¤é€‰é¡¹ï¼š<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">ç¡®å®š</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">å–æ¶ˆ</button>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8sNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

let allOptions = {}, activeFilters = {}, filterOptionsChoices, filterLogic = 'and';
let originalItems = [], timeline = null;

const attributeLabels = {
  EventType: "äº‹ä»¶ç±»å‹",
  Region: "åœ°åŒº",
  Platform: "å¹³å°ç±»å‹",
  Company: "å…¬å¸",
  Status: "çŠ¶æ€",
  ConsolePlatform: "ä¸»æœºç±»å‹"
};

// ----------------- è¿‡æ»¤æ–¹æ³• -----------------
function openFilterWindow(logic) {
  filterLogic = logic;
  document.getElementById('filter-window').style.display = 'block';
}

function resetFilters() { activeFilters = {}; updateFilterList(); updateTimelineByFilter(); }

function updateFilterList() {
  const div = document.getElementById("current-filters");
  div.innerHTML = '';
  for (const [key, values] of Object.entries(activeFilters)) {
    const d = document.createElement("div");
    d.textContent = `${attributeLabels[key] || key}: ${values.join(', ')}`;
    const btn = document.createElement("button");
    btn.textContent = 'âŒ';
    btn.onclick = () => { delete activeFilters[key]; updateFilterList(); updateTimelineByFilter(); };
    d.appendChild(btn);
    div.appendChild(d);
  }
}

function openAddFilter() {
  document.getElementById("add-filter-window").style.display = 'block';
  const attrSel = document.getElementById("filter-attribute");
  attrSel.innerHTML = '';
  Object.keys(attributeLabels).forEach(key => {
    const o = document.createElement("option");
    o.value = key; o.textContent = attributeLabels[key];
    attrSel.appendChild(o);
  });

  attrSel.onchange = () => {
    const key = attrSel.value;
    const opts = getFilterOptionsForKey(key); // ç»Ÿä¸€æ‹¿åˆ°æ•°ç»„
    const sel = document.getElementById("filter-options");
    sel.innerHTML = '';
    opts.forEach(opt => { const o = document.createElement("option"); o.value = o.textContent = opt; sel.appendChild(o); });
    if (filterOptionsChoices) filterOptionsChoices.destroy();
    filterOptionsChoices = new Choices(sel, { removeItemButton: true, shouldSort: false });
  };
  attrSel.dispatchEvent(new Event("change"));
}

function confirmAddFilter() {
  const attr = document.getElementById("filter-attribute").value;
  const selected = Array.from(document.getElementById("filter-options").selectedOptions).map(o => o.value);
  if (attr && selected.length) { activeFilters[attr] = selected; updateFilterList(); }
  document.getElementById("add-filter-window").style.display = 'none';
}

// ç»Ÿä¸€è·å–æ•°ç»„
function normalizeToArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  if (typeof val === 'string') return val.split(',').map(s=>s.trim());
  if (typeof val === 'object') return Object.values(val).flat();
  return [];
}

// âœ… å…³é”®ä¿®æ”¹ï¼šä¸å†å¯¹ ConsolePlatform åšç‰¹æ®Šå¤„ç†
function getFilterOptionsForKey(key) {
  return normalizeToArray(allOptions[key] || []);
}

// ----------------- è¿‡æ»¤é€»è¾‘ -----------------
function valueInSelected(val, selectedArr) {
  if (val == null) return false;
  const vArr = Array.isArray(val) ? val : [val];
  return vArr.some(v => selectedArr.includes(String(v)));
}
function updateTimelineByFilter() {
  if (!timeline || !originalItems) return;
  const filtered = Object.keys(activeFilters).length
    ? originalItems.filter(item => filterLogic==='and'
        ? Object.entries(activeFilters).every(([k,v]) => valueInSelected(item[k],v))
        : Object.entries(activeFilters).some(([k,v]) => valueInSelected(item[k],v)))
    : originalItems;
  timeline.setItems(filtered);
}
function applyFilters() { filterLogic='and'; updateTimelineByFilter(); }
function applyFiltersOr() { filterLogic='or'; updateTimelineByFilter(); }

// ----------------- è·å–äº‹ä»¶å¹¶æ¸²æŸ“ -----------------
fetch(ENDPOINT).then(res=>res.json()).then(data=>{
  originalItems = data.map((event,i)=>{
    const contentText = event.content ?? event.Title ?? '(æ— æ ‡é¢˜)';
    const Start = event.Start ?? event.start ?? '';
    const End   = event.End   ?? event.end   ?? '';
    const blob  = (event.title ?? '').toString();
    const pick = label => blob ? (new RegExp(label+'ï¼š([^\\n]+)').exec(blob) || [])[1] : '';
    const EventType       = event.EventType       ?? event.eventType       ?? pick('äº‹ä»¶ç±»å‹');
    const Region          = event.Region          ?? event.region          ?? pick('åœ°åŒº');
    const Platform        = event.Platform        ?? event.platform        ?? pick('å¹³å°ç±»å‹');
    const Company         = event.Company         ?? event.company         ?? pick('å…¬å¸');
    const Status          = event.Status          ?? event.status          ?? pick('çŠ¶æ€');
    const ConsolePlatform = event.ConsolePlatform ?? event.consolePlatform ?? pick('ä¸»æœºç±»å‹');
    return {id:i+1, content: contentText, start: Start, end: End,
            EventType, Region, Platform, Company, Status, ConsolePlatform};
  });

  // æå–æ‰€æœ‰è¿‡æ»¤é€‰é¡¹
  originalItems.forEach(item => {
    Object.entries(item).forEach(([k,v])=>{
      allOptions[k] = allOptions[k] || new Set();
      (Array.isArray(v)?v:[v]).forEach(val => { if(val!=null) allOptions[k].add(val); });
    });
  });
  Object.keys(allOptions).forEach(k => allOptions[k] = Array.from(allOptions[k]));

  // åˆ›å»ºæ—¶é—´è½´
  const container = document.getElementById('timeline');
  timeline = new vis.Timeline(container, new vis.DataSet(originalItems), {});
});
</script>
</body>
</html>
