<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>时间轴（查看模式）</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <style>
    #timeline { width: 100%; height: 720px; border: 1px solid #ddd; }
    .vis-tooltip {
      white-space: normal !important;
      max-width: 720px !important;
      font-size: 12px; line-height: 1.4;
      background: #fff; border: 1px solid #ccc; padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    .vis-item { font-size: 12px; }
  </style>
</head>
<body>
  <h2>时间轴（查看模式）</h2>
  <button onclick="openFilterWindow('and')">🔍 过滤标准</button>
  <div id="timeline"></div>

  <!-- 过滤逻辑设置弹窗 -->
  <div id="filter-window">
    <h3>过滤标准（和逻辑）</h3>
    <button onclick="openAddFilter()">增加过滤标准</button>
    <button onclick="resetFilters()">复原过滤标准</button>
    <button onclick="applyFilters()">应用和逻辑</button>
    <button onclick="applyFiltersOr()">应用或逻辑</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">关闭</button>
    <div id="current-filters"></div>
  </div>

  <!-- 添加过滤标准弹窗 -->
  <div id="add-filter-window">
    <h3>新增过滤标准</h3>
    <label>过滤属性：<select id="filter-attribute"></select></label><br>
    <label>过滤选项：<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">确定</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">取消</button>
  </div>
  
<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8xSNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

moment.locale("zh-cn");

// 小工具：把 \n 换成 <br> 用于悬停
function nl2br(s) { return (s || '').toString().replace(/\n/g, '<br>'); }

fetch(ENDPOINT)
  .then(r => r.json())
  .then(data => {
    // data 来自 TimelineApproved 的 getTimelineData()
    // 其中 content=Title（用于时间轴短标题），title 为悬停长内容（包含“贡献者”）
    console.log("Viewer events sample:", data[0]); // 调试：看一眼返回结构

    const items = data.map((ev, i) => ({
      id: ev.id || `auto-${i+1}`,
      content: ev.content || '(无标题)',      // 时间轴上的短标题（Title）
      start: ev.start,                        // 必填：开始日期 yyyy-MM-dd
      end: ev.end || undefined,               // 可能为空
      title: nl2br(ev.title || '')            // 悬停框内容：换行成 <br>
    }));

    const container = document.getElementById("timeline");
    const timeline = new vis.Timeline(container, items, {
      locale: "zh-cn",
      editable: false,
      margin: { item: 10, axis: 50 },
      orientation: { axis: 'bottom', item: 'bottom' },
      tooltip: { followMouse: true, overflowMethod: 'flip' },
      verticalScroll: true,
      zoomKey: "ctrlKey",
      stack: true
    });
  })
  .catch(err => {
    console.error("加载时间轴数据失败：", err);
    alert("加载失败，请检查接口可用性（Console 查看详情）");
  });
</script>
</body>
</html>
