<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ—¶é—´è½´ï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <style>
    #timeline { width: 100%; height: 720px; border: 1px solid #ddd; }
    .vis-tooltip {
      white-space: normal !important;
      max-width: 720px !important;
      font-size: 12px; line-height: 1.4;
      background: #fff; border: 1px solid #ccc; padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    .vis-item { font-size: 12px; }
  </style>
</head>
<body>
  <h2>æ—¶é—´è½´ï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰</h2>
  <button onclick="openFilterWindow('and')">ğŸ” è¿‡æ»¤æ ‡å‡†</button>
  <div id="timeline"></div>

  <!-- è¿‡æ»¤é€»è¾‘è®¾ç½®å¼¹çª— -->
  <div id="filter-window">
    <h3>è¿‡æ»¤æ ‡å‡†ï¼ˆå’Œé€»è¾‘ï¼‰</h3>
    <button onclick="openAddFilter()">å¢åŠ è¿‡æ»¤æ ‡å‡†</button>
    <button onclick="resetFilters()">å¤åŸè¿‡æ»¤æ ‡å‡†</button>
    <button onclick="applyFilters()">åº”ç”¨å’Œé€»è¾‘</button>
    <button onclick="applyFiltersOr()">åº”ç”¨æˆ–é€»è¾‘</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">å…³é—­</button>
    <div id="current-filters"></div>
  </div>

  <!-- æ·»åŠ è¿‡æ»¤æ ‡å‡†å¼¹çª— -->
  <div id="add-filter-window">
    <h3>æ–°å¢è¿‡æ»¤æ ‡å‡†</h3>
    <label>è¿‡æ»¤å±æ€§ï¼š<select id="filter-attribute"></select></label><br>
    <label>è¿‡æ»¤é€‰é¡¹ï¼š<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">ç¡®å®š</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">å–æ¶ˆ</button>
  </div>
  
<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8xSNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

moment.locale("zh-cn");

// å°å·¥å…·ï¼šæŠŠ \n æ¢æˆ <br> ç”¨äºæ‚¬åœ
function nl2br(s) { return (s || '').toString().replace(/\n/g, '<br>'); }

fetch(ENDPOINT)
  .then(r => r.json())
  .then(data => {
    // data æ¥è‡ª TimelineApproved çš„ getTimelineData()
    // å…¶ä¸­ content=Titleï¼ˆç”¨äºæ—¶é—´è½´çŸ­æ ‡é¢˜ï¼‰ï¼Œtitle ä¸ºæ‚¬åœé•¿å†…å®¹ï¼ˆåŒ…å«â€œè´¡çŒ®è€…â€ï¼‰
    console.log("Viewer events sample:", data[0]); // è°ƒè¯•ï¼šçœ‹ä¸€çœ¼è¿”å›ç»“æ„

    const items = data.map((ev, i) => ({
      id: ev.id || `auto-${i+1}`,
      content: ev.content || '(æ— æ ‡é¢˜)',      // æ—¶é—´è½´ä¸Šçš„çŸ­æ ‡é¢˜ï¼ˆTitleï¼‰
      start: ev.start,                        // å¿…å¡«ï¼šå¼€å§‹æ—¥æœŸ yyyy-MM-dd
      end: ev.end || undefined,               // å¯èƒ½ä¸ºç©º
      title: nl2br(ev.title || '')            // æ‚¬åœæ¡†å†…å®¹ï¼šæ¢è¡Œæˆ <br>
    }));

    const container = document.getElementById("timeline");
    const timeline = new vis.Timeline(container, items, {
      locale: "zh-cn",
      editable: false,
      margin: { item: 10, axis: 50 },
      orientation: { axis: 'bottom', item: 'bottom' },
      tooltip: { followMouse: true, overflowMethod: 'flip' },
      verticalScroll: true,
      zoomKey: "ctrlKey",
      stack: true
    });
  })
  .catch(err => {
    console.error("åŠ è½½æ—¶é—´è½´æ•°æ®å¤±è´¥ï¼š", err);
    alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¥å£å¯ç”¨æ€§ï¼ˆConsole æŸ¥çœ‹è¯¦æƒ…ï¼‰");
  });
</script>
</body>
</html>
