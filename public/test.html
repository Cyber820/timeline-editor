<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç”µå­æ¸¸æˆæ—¶é—´è½´</title>
  <!-- å¼•å…¥æ‰€éœ€æ ·å¼å’Œåº“ -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    #timeline { width: 100%; height: 800px; border: 1px solid lightgray; position: relative; }
    .vis-tooltip {
      white-space: normal !important; max-width: 700px !important; min-width: 300px;
      font-size: 10px; line-height: 1.2; padding: 12px; background-color: #fff;
      border: 1px solid #ccc; box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }
    .vis-item {
      font-size: 10px; padding: 1px 2px; background-color: #f5f5f5;
      border: 1px solid #aaa; border-radius: 4px; max-width: 300px;
    }
    #filter-window, #add-filter-window, #layout-window {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 20px; border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;
      z-index: 2000; max-height: 80vh; overflow: auto;
    }
    #add-filter-window { width: 700px; height: 300px; }
    #filter-window { width: 700px; }
    /* ğŸŸ¢ å¸ƒå±€è‡ªå®šä¹‰åŠŸèƒ½ */
    #layout-window { width: 700px; height: 400px; }
    #layout-rules-list div { margin: 5px 0; }
  </style>
</head>
<body>
  <h2>ç”µå­æ¸¸æˆæ—¶é—´è½´</h2>
  <!-- åŠŸèƒ½æŒ‰é’® -->
  <button onclick="openFilterWindow('and')">ğŸ” è¿‡æ»¤æ ‡å‡†</button>
  <button onclick="openLayoutWindow()">ğŸ¨ å¸ƒå±€è‡ªå®šä¹‰</button>
  <div id="timeline"></div>

  <!-- è¿‡æ»¤é€»è¾‘è®¾ç½®å¼¹çª— -->
  <div id="filter-window">
    <h3>è¿‡æ»¤æ ‡å‡†ï¼ˆå’Œé€»è¾‘ï¼‰</h3>
    <button onclick="openAddFilter()">å¢åŠ è¿‡æ»¤æ ‡å‡†</button>
    <button onclick="resetFilters()">å¤åŸè¿‡æ»¤æ ‡å‡†</button>
    <button onclick="applyFilters()">åº”ç”¨å’Œé€»è¾‘</button>
    <button onclick="applyFiltersOr()">åº”ç”¨æˆ–é€»è¾‘</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">å…³é—­</button>
    <div id="current-filters"></div>
  </div>

  <!-- æ·»åŠ è¿‡æ»¤æ ‡å‡†å¼¹çª— -->
  <div id="add-filter-window">
    <h3>æ–°å¢è¿‡æ»¤æ ‡å‡†</h3>
    <label>è¿‡æ»¤å±æ€§ï¼š<select id="filter-attribute"></select></label><br>
    <label>è¿‡æ»¤é€‰é¡¹ï¼š<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">ç¡®å®š</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">å–æ¶ˆ</button>
  </div>

  <!-- ğŸŸ¢ å¸ƒå±€è‡ªå®šä¹‰å¼¹çª— -->
  <div id="layout-window">
    <h3>å¸ƒå±€è‡ªå®šä¹‰</h3>
    <label>å±æ€§ï¼š<select id="layout-attribute"></select></label><br>
    <label>æ ·å¼ç±»å‹ï¼š
      <select id="layout-style-type">
        <option value="fontColor">å­—ä½“é¢œè‰²</option>
        <option value="backgroundColor">è¾¹æ¡†é¢œè‰²</option>
        <option value="fillColor">å¡«å……é¢œè‰²</option>
      </select>
    </label><br>
    <label>å…·ä½“å±æ€§å€¼ï¼š<input id="layout-value-text" placeholder="ä¾‹å¦‚ï¼šä¸»æœºæ¸¸æˆ"></label>
    <label>æ ·å¼å€¼ï¼š<input id="layout-style-text" placeholder="ä¾‹å¦‚ï¼šred æˆ– #ff0000"></label>
    <button onclick="addLayoutRule()">æ·»åŠ è§„åˆ™</button>
    <button onclick="resetLayoutRules()">é‡ç½®è§„åˆ™</button>
    <button onclick="document.getElementById('layout-window').style.display='none'">å…³é—­</button>
    <div id="layout-rules-list"></div>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8xSNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

let allOptions = {}, activeFilters = {}, filterLogic = 'and';
let originalItems = [], timeline = null;

/* ğŸŸ¢ å¸ƒå±€è‡ªå®šä¹‰åŠŸèƒ½ */
let layoutRules = {}; // {å±æ€§: {styleType, values:{å…·ä½“å€¼:æ ·å¼}}}

const attributeLabels = {
  EventType: "äº‹ä»¶ç±»å‹",
  Region: "åœ°åŒº",
  Platform: "å¹³å°ç±»å‹",
  Company: "å…¬å¸",
  Status: "çŠ¶æ€",
  ConsolePlatform: "ä¸»æœºç±»å‹",
  Contributor: "è´¡çŒ®è€…"
};

// ---------- åŸæœ‰è¿‡æ»¤åŠŸèƒ½ ----------
function openFilterWindow(logic) { filterLogic = logic; document.getElementById('filter-window').style.display = 'block'; }
function resetFilters() { activeFilters = {}; updateFilterList(); updateTimelineByFilter(); }
function updateFilterList() {
  const div = document.getElementById("current-filters");
  div.innerHTML = '';
  for (const [key, values] of Object.entries(activeFilters)) {
    const d = document.createElement("div");
    d.textContent = `${attributeLabels[key] || key}: ${values.join(', ')}`;
    const btn = document.createElement("button");
    btn.textContent = 'âŒ';
    btn.onclick = () => { delete activeFilters[key]; updateFilterList(); updateTimelineByFilter(); };
    d.appendChild(btn);
    div.appendChild(d);
  }
}
function applyFilters() { filterLogic = 'and'; updateTimelineByFilter(); }
function applyFiltersOr() { filterLogic = 'or'; updateTimelineByFilter(); }
function updateTimelineByFilter() {
  const filtered = originalItems.filter(item => {
    const pass = (filterLogic==='and')
      ? Object.entries(activeFilters).every(([k, vals]) => vals.includes(String(item[k] ?? '')))
      : Object.entries(activeFilters).some(([k, vals]) => vals.includes(String(item[k] ?? '')));
    return pass;
  });
  timeline.setItems(filtered);
}
function openAddFilter() {
  document.getElementById("add-filter-window").style.display = 'block';
  const attrSel = document.getElementById("filter-attribute");
  attrSel.innerHTML = '';
  const attributes = ['EventType','Region','Platform','Company','Status','ConsolePlatform','Contributor'];
  attributes.forEach(key => { const o=document.createElement("option"); o.value=o.textContent=key; attrSel.appendChild(o); });
  attrSel.onchange = () => {
    const key = attrSel.value;
    const opts = getFilterOptionsForKey(key); 
    const sel = document.getElementById("filter-options");
    sel.innerHTML = '';
    opts.forEach(opt => { const o=document.createElement("option"); o.value=o.textContent=opt; sel.appendChild(o); });
  };
  attrSel.dispatchEvent(new Event("change"));
}
function confirmAddFilter() {
  const attr = document.getElementById("filter-attribute").value;
  const selected = Array.from(document.getElementById("filter-options").selectedOptions).map(o=>o.value);
  if(attr && selected.length) { activeFilters[attr] = selected; updateFilterList(); }
  document.getElementById("add-filter-window").style.display='none';
}
function normalizeToArray(raw) { if(Array.isArray(raw)) return raw; if(typeof raw==='string') return [raw]; if(raw && typeof raw==='object'){try{return Object.values(raw);}catch(e){return []}} return []; }
function getFilterOptionsForKey(key){return [...new Set(originalItems.map(i=>i[key]).filter(Boolean))];}

// ---------- ğŸŸ¢ å¸ƒå±€è‡ªå®šä¹‰åŠŸèƒ½ ----------
function openLayoutWindow() {
  const sel = document.getElementById("layout-attribute");
  sel.innerHTML='';
  const attributes = ['EventType','Region','Platform','Company','Status','ConsolePlatform','Contributor'];
  attributes.forEach(k => { const o=document.createElement("option"); o.value=o.textContent=k; sel.appendChild(o); });
  updateLayoutRulesList();
  document.getElementById("layout-window").style.display = 'block';
}

function addLayoutRule() {
  const attr = document.getElementById("layout-attribute").value;
  const type = document.getElementById("layout-style-type").value;
  const val = document.getElementById("layout-value-text").value.trim();
  const styleVal = document.getElementById("layout-style-text").value.trim();
  if(!attr || !type || !val || !styleVal) { alert('è¯·å®Œæ•´å¡«å†™'); return; }
  if(!layoutRules[attr]) layoutRules[attr] = {styleType:type, values:{}};
  layoutRules[attr].values[val] = styleVal;
  applyLayoutRules();
  updateLayoutRulesList();
}

function resetLayoutRules() { layoutRules={}; applyLayoutRules(); updateLayoutRulesList(); }

function updateLayoutRulesList() {
  const div = document.getElementById("layout-rules-list");
  div.innerHTML='';
  for(const [attr, rule] of Object.entries(layoutRules)){
    for(const [val, styleVal] of Object.entries(rule.values)){
      const d = document.createElement("div");
      d.textContent = `${attributeLabels[attr] || attr}=${val} â†’ ${rule.styleType}: ${styleVal}`;
      const btn = document.createElement("button"); btn.textContent='âŒ';
      btn.onclick=()=>{
        delete layoutRules[attr].values[val];
        if(Object.keys(layoutRules[attr].values).length===0) delete layoutRules[attr];
        applyLayoutRules(); updateLayoutRulesList();
      };
      d.appendChild(btn); div.appendChild(d);
    }
  }
}

function applyLayoutRules() {
  if(!timeline) return;
  timeline.setItems(originalItems.map(item=>{
    let style='';
    for(const [attr, rule] of Object.entries(layoutRules)){
      const val = item[attr];
      if(val && rule.values[val]){
        if(rule.styleType==='fontColor') style+=`color:${rule.values[val]};`;
        else if(rule.styleType==='backgroundColor') style+=`border-color:${rule.values[val]};`;
        else if(rule.styleType==='fillColor') style+=`background-color:${rule.values[val]};`;
      }
    }
    return {...item, style};
  }));
}

// ---------- åˆå§‹åŒ–æ—¶é—´è½´ ----------
fetch(ENDPOINT).then(r=>r.json()).then(data=>{
  originalItems = data.map((e,i)=>({id:i, content:e.Title, start:e.Start, end:e.End, EventType:e.EventType, Region:e.Region, Platform:e.Platform, Company:e.Company, Status:e.Status, ConsolePlatform:e.ConsolePlatform, Contributor:e.Contributor || '', style:''}));
  const container = document.getElementById("timeline");
  const items = new vis.DataSet(originalItems);
  const options = {editable:false, stack:true, multiselect:true, orientation:'top', zoomable:true, margin:{item:10, axis:5}, tooltip:{followMouse:true}};
  timeline = new vis.Timeline(container, items, options);
});

</script>
</body>
</html>
