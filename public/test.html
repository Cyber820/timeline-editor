<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>电子游戏时间轴</title>
  <!-- 样式和库 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    #timeline { width: 100%; height: 800px; border: 1px solid lightgray; position: relative; }
    .vis-tooltip {
      white-space: normal !important; max-width: 700px !important; min-width: 300px;
      font-size: 10px; line-height: 1.2; padding: 12px; background-color: #fff;
      border: 1px solid #ccc; box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }
    .vis-item { font-size: 10px; padding: 1px 2px; background-color: #f5f5f5; border: 1px solid #aaa; border-radius: 4px; max-width: 300px; }
    #filter-window, #add-filter-window {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 20px; border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; z-index: 2000;
      max-height: 80vh; overflow: auto;
    }
    #filter-window { width: 700px; }
    #add-filter-window { width: 700px; height: 300px; }
  </style>
</head>
<body>
  <h2>电子游戏时间轴</h2>
  <button onclick="openFilterWindow('and')">🔍 过滤标准</button>
  <div id="timeline"></div>

  <!-- 过滤窗口 -->
  <div id="filter-window">
    <h3>过滤标准（和逻辑）</h3>
    <button onclick="openAddFilter()">增加过滤标准</button>
    <button onclick="resetFilters()">复原过滤标准</button>
    <button onclick="applyFilters()">应用和逻辑</button>
    <button onclick="applyFiltersOr()">应用或逻辑</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">关闭</button>
    <div id="current-filters"></div>
  </div>

  <!-- 添加过滤标准窗口 -->
  <div id="add-filter-window">
    <h3>新增过滤标准</h3>
    <label>过滤属性：<select id="filter-attribute"></select></label><br>
    <label>过滤选项：<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">确定</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">取消</button>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8sNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

let allOptions = {}, activeFilters = {}, filterOptionsChoices, filterLogic = 'and';
let originalItems = [], timeline = null;

const attributeLabels = {
  EventType: "事件类型",
  Region: "地区",
  Platform: "平台类型",
  Company: "公司",
  Status: "状态",
  ConsolePlatform: "主机类型"
};

// ----------------- 过滤方法 -----------------
function openFilterWindow(logic) {
  filterLogic = logic;
  document.getElementById('filter-window').style.display = 'block';
}

function resetFilters() { activeFilters = {}; updateFilterList(); updateTimelineByFilter(); }

function updateFilterList() {
  const div = document.getElementById("current-filters");
  div.innerHTML = '';
  for (const [key, values] of Object.entries(activeFilters)) {
    const d = document.createElement("div");
    d.textContent = `${attributeLabels[key] || key}: ${values.join(', ')}`;
    const btn = document.createElement("button");
    btn.textContent = '❌';
    btn.onclick = () => { delete activeFilters[key]; updateFilterList(); updateTimelineByFilter(); };
    d.appendChild(btn);
    div.appendChild(d);
  }
}

function openAddFilter() {
  document.getElementById("add-filter-window").style.display = 'block';
  const attrSel = document.getElementById("filter-attribute");
  attrSel.innerHTML = '';
  Object.keys(attributeLabels).forEach(key => {
    const o = document.createElement("option");
    o.value = key; o.textContent = attributeLabels[key];
    attrSel.appendChild(o);
  });

  attrSel.onchange = () => {
    const key = attrSel.value;
    const opts = getFilterOptionsForKey(key); // 统一拿到数组
    const sel = document.getElementById("filter-options");
    sel.innerHTML = '';
    opts.forEach(opt => { const o = document.createElement("option"); o.value = o.textContent = opt; sel.appendChild(o); });
    if (filterOptionsChoices) filterOptionsChoices.destroy();
    filterOptionsChoices = new Choices(sel, { removeItemButton: true, shouldSort: false });
  };
  attrSel.dispatchEvent(new Event("change"));
}

function confirmAddFilter() {
  const attr = document.getElementById("filter-attribute").value;
  const selected = Array.from(document.getElementById("filter-options").selectedOptions).map(o => o.value);
  if (attr && selected.length) { activeFilters[attr] = selected; updateFilterList(); }
  document.getElementById("add-filter-window").style.display = 'none';
}

// 统一获取数组
function normalizeToArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  if (typeof val === 'string') return val.split(',').map(s=>s.trim());
  if (typeof val === 'object') return Object.values(val).flat();
  return [];
}

// ✅ 关键修改：不再对 ConsolePlatform 做特殊处理
function getFilterOptionsForKey(key) {
  return normalizeToArray(allOptions[key] || []);
}

// ----------------- 过滤逻辑 -----------------
function valueInSelected(val, selectedArr) {
  if (val == null) return false;
  const vArr = Array.isArray(val) ? val : [val];
  return vArr.some(v => selectedArr.includes(String(v)));
}
function updateTimelineByFilter() {
  if (!timeline || !originalItems) return;
  const filtered = Object.keys(activeFilters).length
    ? originalItems.filter(item => filterLogic==='and'
        ? Object.entries(activeFilters).every(([k,v]) => valueInSelected(item[k],v))
        : Object.entries(activeFilters).some(([k,v]) => valueInSelected(item[k],v)))
    : originalItems;
  timeline.setItems(filtered);
}
function applyFilters() { filterLogic='and'; updateTimelineByFilter(); }
function applyFiltersOr() { filterLogic='or'; updateTimelineByFilter(); }

// ----------------- 获取事件并渲染 -----------------
fetch(ENDPOINT).then(res=>res.json()).then(data=>{
  originalItems = data.map((event,i)=>{
    const contentText = event.content ?? event.Title ?? '(无标题)';
    const Start = event.Start ?? event.start ?? '';
    const End   = event.End   ?? event.end   ?? '';
    const blob  = (event.title ?? '').toString();
    const pick = label => blob ? (new RegExp(label+'：([^\\n]+)').exec(blob) || [])[1] : '';
    const EventType       = event.EventType       ?? event.eventType       ?? pick('事件类型');
    const Region          = event.Region          ?? event.region          ?? pick('地区');
    const Platform        = event.Platform        ?? event.platform        ?? pick('平台类型');
    const Company         = event.Company         ?? event.company         ?? pick('公司');
    const Status          = event.Status          ?? event.status          ?? pick('状态');
    const ConsolePlatform = event.ConsolePlatform ?? event.consolePlatform ?? pick('主机类型');
    return {id:i+1, content: contentText, start: Start, end: End,
            EventType, Region, Platform, Company, Status, ConsolePlatform};
  });

  // 提取所有过滤选项
  originalItems.forEach(item => {
    Object.entries(item).forEach(([k,v])=>{
      allOptions[k] = allOptions[k] || new Set();
      (Array.isArray(v)?v:[v]).forEach(val => { if(val!=null) allOptions[k].add(val); });
    });
  });
  Object.keys(allOptions).forEach(k => allOptions[k] = Array.from(allOptions[k]));

  // 创建时间轴
  const container = document.getElementById('timeline');
  timeline = new vis.Timeline(container, new vis.DataSet(originalItems), {});
});
</script>
</body>
</html>
