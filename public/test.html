<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>电子游戏时间轴</title>
  <!-- 引入所需样式和库 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/zh-cn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    #timeline { width: 100%; height: 800px; border: 1px solid lightgray; position: relative; }
    .vis-tooltip {
      white-space: normal !important; max-width: 700px !important; min-width: 300px;
      font-size: 10px; line-height: 1.2; padding: 12px; background-color: #fff;
      border: 1px solid #ccc; box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }
    .vis-item {
      font-size: 10px; padding: 1px 2px; background-color: #f5f5f5;
      border: 1px solid #aaa; border-radius: 4px; max-width: 300px;
    }
    #filter-window, #add-filter-window, #layout-window {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 20px; border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;
      z-index: 2000; max-height: 80vh; overflow: auto;
    }
    #add-filter-window { width: 700px; height: 300px; }
    #filter-window { width: 700px; }
    /* 🟢 布局自定义功能 */
    #layout-window { width: 700px; height: 400px; }
    #layout-rules-list div { margin: 5px 0; }
  </style>
</head>
<body>
  <h2>电子游戏时间轴</h2>
  <!-- 功能按钮 -->
  <button onclick="openFilterWindow('and')">🔍 过滤标准</button>
  <button onclick="openLayoutWindow()">🎨 布局自定义</button>
  <div id="timeline"></div>

  <!-- 过滤逻辑设置弹窗 -->
  <div id="filter-window">
    <h3>过滤标准（和逻辑）</h3>
    <button onclick="openAddFilter()">增加过滤标准</button>
    <button onclick="resetFilters()">复原过滤标准</button>
    <button onclick="applyFilters()">应用和逻辑</button>
    <button onclick="applyFiltersOr()">应用或逻辑</button>
    <button onclick="document.getElementById('filter-window').style.display='none'">关闭</button>
    <div id="current-filters"></div>
  </div>

  <!-- 添加过滤标准弹窗 -->
  <div id="add-filter-window">
    <h3>新增过滤标准</h3>
    <label>过滤属性：<select id="filter-attribute"></select></label><br>
    <label>过滤选项：<select id="filter-options" multiple></select></label><br>
    <button onclick="confirmAddFilter()">确定</button>
    <button onclick="document.getElementById('add-filter-window').style.display='none'">取消</button>
  </div>

  <!-- 🟢 布局自定义弹窗 -->
  <div id="layout-window">
    <h3>布局自定义</h3>
    <label>属性：<select id="layout-attribute"></select></label><br>
    <label>样式类型：
      <select id="layout-style-type">
        <option value="fontColor">字体颜色</option>
        <option value="backgroundColor">边框颜色</option>
        <option value="fillColor">填充颜色</option>
      </select>
    </label><br>
    <label>具体属性值：<input id="layout-value-text" placeholder="例如：主机游戏"></label>
    <label>样式值：<input id="layout-style-text" placeholder="例如：red 或 #ff0000"></label>
    <button onclick="addLayoutRule()">添加规则</button>
    <button onclick="resetLayoutRules()">重置规则</button>
    <button onclick="document.getElementById('layout-window').style.display='none'">关闭</button>
    <div id="layout-rules-list"></div>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxe-P-iT8Jv8xSNTqdYB7SMi4sy2pPl8lLZ2EWqaXsP-jz6nfsxdJ1a0lzNSGB-e_1U/exec";

let allOptions = {}, activeFilters = {}, filterLogic = 'and';
let originalItems = [], timeline = null;

/* 🟢 布局自定义功能 */
let layoutRules = {}; // {属性: {styleType, values:{具体值:样式}}}

const attributeLabels = {
  EventType: "事件类型",
  Region: "地区",
  Platform: "平台类型",
  Company: "公司",
  Status: "状态",
  ConsolePlatform: "主机类型",
  Contributor: "贡献者"
};

// ---------- 原有过滤功能 ----------
function openFilterWindow(logic) { filterLogic = logic; document.getElementById('filter-window').style.display = 'block'; }
function resetFilters() { activeFilters = {}; updateFilterList(); updateTimelineByFilter(); }
function updateFilterList() {
  const div = document.getElementById("current-filters");
  div.innerHTML = '';
  for (const [key, values] of Object.entries(activeFilters)) {
    const d = document.createElement("div");
    d.textContent = `${attributeLabels[key] || key}: ${values.join(', ')}`;
    const btn = document.createElement("button");
    btn.textContent = '❌';
    btn.onclick = () => { delete activeFilters[key]; updateFilterList(); updateTimelineByFilter(); };
    d.appendChild(btn);
    div.appendChild(d);
  }
}
function applyFilters() { filterLogic = 'and'; updateTimelineByFilter(); }
function applyFiltersOr() { filterLogic = 'or'; updateTimelineByFilter(); }
function updateTimelineByFilter() {
  const filtered = originalItems.filter(item => {
    const pass = (filterLogic==='and')
      ? Object.entries(activeFilters).every(([k, vals]) => vals.includes(String(item[k] ?? '')))
      : Object.entries(activeFilters).some(([k, vals]) => vals.includes(String(item[k] ?? '')));
    return pass;
  });
  timeline.setItems(filtered);
}
function openAddFilter() {
  document.getElementById("add-filter-window").style.display = 'block';
  const attrSel = document.getElementById("filter-attribute");
  attrSel.innerHTML = '';
  const attributes = ['EventType','Region','Platform','Company','Status','ConsolePlatform','Contributor'];
  attributes.forEach(key => { const o=document.createElement("option"); o.value=o.textContent=key; attrSel.appendChild(o); });
  attrSel.onchange = () => {
    const key = attrSel.value;
    const opts = getFilterOptionsForKey(key); 
    const sel = document.getElementById("filter-options");
    sel.innerHTML = '';
    opts.forEach(opt => { const o=document.createElement("option"); o.value=o.textContent=opt; sel.appendChild(o); });
  };
  attrSel.dispatchEvent(new Event("change"));
}
function confirmAddFilter() {
  const attr = document.getElementById("filter-attribute").value;
  const selected = Array.from(document.getElementById("filter-options").selectedOptions).map(o=>o.value);
  if(attr && selected.length) { activeFilters[attr] = selected; updateFilterList(); }
  document.getElementById("add-filter-window").style.display='none';
}
function normalizeToArray(raw) { if(Array.isArray(raw)) return raw; if(typeof raw==='string') return [raw]; if(raw && typeof raw==='object'){try{return Object.values(raw);}catch(e){return []}} return []; }
function getFilterOptionsForKey(key){return [...new Set(originalItems.map(i=>i[key]).filter(Boolean))];}

// ---------- 🟢 布局自定义功能 ----------
function openLayoutWindow() {
  const sel = document.getElementById("layout-attribute");
  sel.innerHTML='';
  const attributes = ['EventType','Region','Platform','Company','Status','ConsolePlatform','Contributor'];
  attributes.forEach(k => { const o=document.createElement("option"); o.value=o.textContent=k; sel.appendChild(o); });
  updateLayoutRulesList();
  document.getElementById("layout-window").style.display = 'block';
}

function addLayoutRule() {
  const attr = document.getElementById("layout-attribute").value;
  const type = document.getElementById("layout-style-type").value;
  const val = document.getElementById("layout-value-text").value.trim();
  const styleVal = document.getElementById("layout-style-text").value.trim();
  if(!attr || !type || !val || !styleVal) { alert('请完整填写'); return; }
  if(!layoutRules[attr]) layoutRules[attr] = {styleType:type, values:{}};
  layoutRules[attr].values[val] = styleVal;
  applyLayoutRules();
  updateLayoutRulesList();
}

function resetLayoutRules() { layoutRules={}; applyLayoutRules(); updateLayoutRulesList(); }

function updateLayoutRulesList() {
  const div = document.getElementById("layout-rules-list");
  div.innerHTML='';
  for(const [attr, rule] of Object.entries(layoutRules)){
    for(const [val, styleVal] of Object.entries(rule.values)){
      const d = document.createElement("div");
      d.textContent = `${attributeLabels[attr] || attr}=${val} → ${rule.styleType}: ${styleVal}`;
      const btn = document.createElement("button"); btn.textContent='❌';
      btn.onclick=()=>{
        delete layoutRules[attr].values[val];
        if(Object.keys(layoutRules[attr].values).length===0) delete layoutRules[attr];
        applyLayoutRules(); updateLayoutRulesList();
      };
      d.appendChild(btn); div.appendChild(d);
    }
  }
}

function applyLayoutRules() {
  if(!timeline) return;
  timeline.setItems(originalItems.map(item=>{
    let style='';
    for(const [attr, rule] of Object.entries(layoutRules)){
      const val = item[attr];
      if(val && rule.values[val]){
        if(rule.styleType==='fontColor') style+=`color:${rule.values[val]};`;
        else if(rule.styleType==='backgroundColor') style+=`border-color:${rule.values[val]};`;
        else if(rule.styleType==='fillColor') style+=`background-color:${rule.values[val]};`;
      }
    }
    return {...item, style};
  }));
}

// ---------- 初始化时间轴 ----------
fetch(ENDPOINT).then(r=>r.json()).then(data=>{
  originalItems = data.map((e,i)=>({id:i, content:e.Title, start:e.Start, end:e.End, EventType:e.EventType, Region:e.Region, Platform:e.Platform, Company:e.Company, Status:e.Status, ConsolePlatform:e.ConsolePlatform, Contributor:e.Contributor || '', style:''}));
  const container = document.getElementById("timeline");
  const items = new vis.DataSet(originalItems);
  const options = {editable:false, stack:true, multiselect:true, orientation:'top', zoomable:true, margin:{item:10, axis:5}, tooltip:{followMouse:true}};
  timeline = new vis.Timeline(container, items, options);
});

</script>
</body>
</html>
